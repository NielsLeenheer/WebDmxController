


<style>

    #inputs {
        display: grid;
        grid-template-columns: repeat(16, 1fr);
        /* gap: 10px; */
        /* padding: 20px; */
    }

    #inputs input {
        border: none;
        padding: 3px;
    }
    #inputs input:focus {
        z-index: 1;
    }

</style>


<body>

    <header>

        <button onclick="connect()">Connect</button>

    </header>

    <div id="devices">  

    </div>

    <hr>

    <div id="inputs">

    </div>

</body>


<script>

    const ENTTEC_PRO_DMX_STARTCODE = 0x00;
    const ENTTEC_PRO_START_OF_MSG = 0x7e;
    const ENTTEC_PRO_END_OF_MSG = 0xe7;
    const ENTTEC_PRO_SEND_DMX_RQ = 0x06;

    let universe = new Uint8Array(512).fill(0);

    let devices = [];


    let interval = 1000 / 60; 
    let method = 'webusb';

    let writer;

    async function connect() {

        /* Connect using WebUSB */

        if (method === 'webusb' && 'usb' in navigator) {
            let device = await navigator.usb.requestDevice({ filters: [{ vendorId: 0x0403 }] });
            await device.open();
            await device.claimInterface(0);

            device.controlTransferOut({
                requestType: 'class',
                recipient: 'interface',
                request: 0x22,
                value: 0x01,
                index: 0x00
            });

            setInterval(() => {
                if (device) {
                    let message = getUniverse();
                    console.log("Sending message:", message);
                    device.transferOut(2, message);
                }
            }, interval);
        }

        /* Connect using WebSerial */

        if (method === 'webserial' && 'serial' in navigator) {
            let port = await navigator.serial.requestPort();

            await port.open({ 
                'baudRate': 250000,
                'dataBits': 8,
                'stopBits': 2,
                'parity': 'none',
                'bufferSize': 600
            });

            writer = port.writable.getWriter();

            setInterval(() => {
                if (writer) {
                    writer.write(getUniverse());
                }
            }, interval);
        }
    }

    function getUniverse() {
        let message = Uint8Array.from([
            ENTTEC_PRO_DMX_STARTCODE,
            ...universe
        ]);

        return Uint8Array.from([
            ENTTEC_PRO_START_OF_MSG,
            ENTTEC_PRO_SEND_DMX_RQ,
            message.length & 0xff,
            (message.length >> 8) & 0xff,
            ...message,
            ENTTEC_PRO_END_OF_MSG
        ]);
    }

    function updateUniverse(i, value) {
        universe[i] = value;

        let input = document.getElementById("input" + i);
        if (input) {
            input.value = value;
        }
    }


    let inputs = document.getElementById("inputs");

    for (i = 0; i < 512; i++) {
        let input = document.createElement("input");
        input.type = "number";
        input.value = 0;
        input.min = 0;
        input.max = 255;
        input.id = "input" + i;
        
        input.onchange = function() {
            universe[parseInt(this.id.replace("input", ""))] = parseInt(this.value);
        };

        inputs.appendChild(input);
    }


    class MovingHeadUnit {

        constructor(parent, channel) {
            this.parent = parent;
            this.channel = channel;

            this.pan = 0;
            this.tilt = 0;
            this.dimming = 255;
            this.strobe = 0;
            this.r = 0;
            this.g = 0;
            this.b = 0;
            this.w = 0;

            this.build();
        }

        build() {
            let container = document.createElement("div");
            container.className = "MovingHeadUnit";
            this.parent.appendChild(container);

            /* Pan */

            let pan = document.createElement("input");
            pan.type = "range";
            pan.style.accentColor = "#888";
            pan.min = 0;
            pan.max = 255;
            pan.value = this.pan;
            pan.oninput = () => {
                this.pan = parseInt(pan.value);
                this.update();  
            };
            container.appendChild(pan);

            /* Tilt */

            let tilt = document.createElement("input");
            tilt.type = "range";
            tilt.style.accentColor = "#888";
            tilt.min = 0;
            tilt.max = 255;
            tilt.value = this.tilt;
            tilt.oninput = () => {
                this.tilt = parseInt(tilt.value);
                this.update();
            };
            container.appendChild(tilt);

            /* Dimming */

            let dimming = document.createElement("input");
            dimming.type = "range";
            dimming.style.accentColor = "#888";
            dimming.min = 0;
            dimming.max = 255;
            dimming.value = this.dimming;
            dimming.oninput = () => {
                this.dimming = parseInt(dimming.value);
                this.update();
            };
            container.appendChild(dimming);

            let red = document.createElement("input");
            red.type = "range";
            red.style.accentColor = "#a00";
            red.min = 0;
            red.max = 255;
            red.value = this.r;
            red.oninput = () => {
                this.r = parseInt(red.value);
                this.update();
            };
            container.appendChild(red);

            let green = document.createElement("input");
            green.type = "range";
            green.style.accentColor = "#080";
            green.min = 0;
            green.max = 255;
            green.value = this.g;
            green.oninput = () => {
                this.g = parseInt(green.value);
                this.update();
            };
            container.appendChild(green);

            let blue = document.createElement("input");
            blue.type = "range";
            blue.style.accentColor = "#00a";
            blue.min = 0;
            blue.max = 255;
            blue.value = this.b;
            blue.oninput = () => {
                this.b = parseInt(blue.value);
                this.update();
            };
            container.appendChild(blue);


            let white = document.createElement("input");
            white.type = "range";
            white.style.accentColor = "#888";
            white.min = 0;
            white.max = 255;
            white.value = this.w;
            white.oninput = () => {
                this.w = parseInt(white.value);
                this.update();
            };
            container.appendChild(white);

            // /* Color */
            // let color = document.createElement("input");
            // color.type = "color";
            // color.oninput = () => {
            //     let rgb = this.hexToRgb(color.value);
            //     this.r = rgb.r;
            //     this.g = rgb.g;
            //     this.b = rgb.b;
            //     this.update();
            // };

            // container.appendChild(color)
        }

        hexToRgb(hex) {
            let bigint = parseInt(hex.slice(1), 16);
            return {
                r: (bigint >> 16) & 255,
                g: (bigint >> 8) & 255,
                b: bigint & 255
            };
        }

        update() {
            updateUniverse(this.channel, this.pan);
            updateUniverse(this.channel + 2, this.tilt);
            updateUniverse(this.channel + 5, this.dimming);
            updateUniverse(this.channel + 6, this.strobe);
            updateUniverse(this.channel + 7, this.r);
            updateUniverse(this.channel + 8, this.g);
            updateUniverse(this.channel + 9, this.b);
            updateUniverse(this.channel + 10, this.w);
        }
    }


    let lamp = new MovingHeadUnit(document.getElementById('devices'), 0);

</script>